#!/usr/bin/env node

var _ = require("underscore");
var program = require("commander");
var tisdk = require("../index");
var chalk = require("chalk");
var fs = require("fs");
var path = require("path");
var rimraf = require("rimraf");
var appc = require("node-appc");
var os =  require('os');

var TITANIUM, platform;


if (os.platform()=="linux"){
  TITANIUM = path.join(process.env.HOME, '.titanium');
  platform = "linux";
} else if (os.platform() === "win32") {
  TITANIUM = path.join(process.cwd().split(path.sep)[0], "ProgramData", "Titanium");
  platform = "win32";
} else {
  TITANIUM = path.join(process.env.HOME, 'Library', 'Application Support', 'Titanium');
  platform = "osx";
}

program
.version(require("../package.json").version);

program
.command("list")
.option("-g, --ga-only", "List GA releases only")
.description("List available GA releases")
.action(function(o) {
  tisdk.getGATags(function(tags) {
    tags.map(function(tag) {
      var version = tag.name.replace(/_/g, ".");
      var type = version.split(".")[3];
      if (type==="GA") {
        console.log(chalk.bold.green(version) + "\t" +  chalk.grey(tag.commit.sha));
      } else if (!o.gaOnly) {
        console.log(version + "\t" +  chalk.grey(tag.commit.sha));
      }
    });
  });
});

program
.description("Install a GA version")
.command("install [version]")
.option("-f, --force", "Overwrite existing install")
.action(function(version, options) {

  var tmp_file = "mobilesdk-" + version + "-"+platform+".zip";
  var target = path.join(TITANIUM, "mobilesdk", platform, version);
  var overwrite = !!options.force;
  if (fs.existsSync(target) && !overwrite) {
    console.log(chalk.red("ERROR") + ": SDK already installed. Use the --force flag to overwrite existing install.");
    return;
  };
  tisdk.download(version, tmp_file, function(build){
    console.log("Unzipping...");
    appc.zip.unzip(tmp_file, TITANIUM, {
      visitor: function(entry, i, len) {
        process.stdout.clearLine();
        process.stdout.cursorTo(0);
        process.stdout.write("Unzipping (" + i + "/" + len + ") : " + chalk.grey(entry.entryName) );
      }
    }, function() {
      var source = path.join(TITANIUM, "mobilesdk", platform, build.filename.split("-")[1]);
      console.log("");
      if (overwrite) {
        console.log("Removing old " + target);
        rimraf.sync(target);
      }
      console.log("Renaming " + source + " to " + target);
      fs.renameSync(source, target);
      fs.unlinkSync(tmp_file);
      console.log("Installed Successfully!");
    });
  });

});


program
.description("Download a GA version")
.command("download [version]")
.action(function(version) {
  var tmp_file = "mobilesdk-" + version + "-"+platform+".zip";
  tisdk.download(version, tmp_file, function(build){
    console.log("Done.");
  });
});

program.parse(process.argv);
if (program.args.length === 0 || typeof program.args[program.args.length -1] === 'string'){
  program.help();
}
